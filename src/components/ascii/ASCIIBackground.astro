---
import type { EffectType } from '@/lib/ascii';

interface Props {
  effect?: EffectType;
}

const { effect = 'wave' } = Astro.props;
---

<div
  id="ascii-background"
  class="ascii-background"
  role="img"
  aria-label="Animated ASCII art background"
  aria-hidden="true"
  data-effect={effect}
>
</div>

<script>
  import { ASCIIRenderer, type EffectType } from '@/lib/ascii';
  import { loadPreferences, COLOR_THEMES } from '@/lib/preferences';

  // Intensity settings for different page types
  const HOME_INTENSITY = 0.8;
  const CONTENT_INTENSITY = 0.5;
  const REDUCED_MOTION_INTENSITY = 0.25;
  const TWEEN_DURATION = 600; // ms

  function isHomePage(): boolean {
    return window.location.pathname === '/' || window.location.pathname === '';
  }

  function getPageIntensity(reducedMotion: boolean): number {
    if (reducedMotion) return REDUCED_MOTION_INTENSITY;
    return isHomePage() ? HOME_INTENSITY : CONTENT_INTENSITY;
  }

  let renderer: ASCIIRenderer | null = null;
  let reducedMotion = false;

  function initASCII() {
    const container = document.getElementById('ascii-background');
    if (!container) return;

    // Load saved preferences
    const prefs = loadPreferences();
    const effect = prefs.effect || (container.dataset.effect as EffectType) || 'wave';
    const colorTheme = COLOR_THEMES[prefs.colorTheme] || COLOR_THEMES.green;

    // Check for reduced motion preference
    reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Detect mobile for performance adjustments
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // Calculate initial intensity based on page and motion preference
    const initialIntensity = getPageIntensity(reducedMotion);

    try {
      renderer = new ASCIIRenderer({
        container,
        effect,
        fontSize: isMobile ? 16 : 14,
        speed: reducedMotion ? 0.3 : (prefs.speed || 1), // Slow down for reduced motion
        intensity: initialIntensity,
        color: colorTheme.primary,
        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim() || '#0f0f0f',
      });

      // On reduced motion, render static frame; otherwise animate
      if (reducedMotion) {
        container.style.opacity = '0.3';
        renderer.renderStaticFrame();
      } else {
        renderer.start();
      }
    } catch (error) {
      console.error('Failed to initialize ASCII renderer:', error);
    }

    // Listen for settings changes from the SettingsPanel
    const handleSettingsChange = (e: CustomEvent<{
      effect: EffectType;
      speed: number;
      intensity: number;
      color: string;
    }>) => {
      if (renderer) {
        renderer.setEffect(e.detail.effect);
        renderer.setSpeed(e.detail.speed);
        renderer.setIntensity(e.detail.intensity);
        renderer.setColor(e.detail.color);
      }
    };

    // Legacy: Listen for effect changes from CLI (if still used)
    const handleEffectChange = (e: CustomEvent<EffectType>) => {
      if (renderer) {
        renderer.setEffect(e.detail);
      }
    };

    const handleExplosion = (e: CustomEvent<{x: number, y: number}>) => {
      if (renderer) {
        renderer.triggerExplosion(e.detail.x, e.detail.y);
      }
    };

    window.addEventListener('ascii-settings-change', handleSettingsChange as EventListener);
    window.addEventListener('ascii-effect-change', handleEffectChange as EventListener);
    window.addEventListener('ascii-trigger-explosion', handleExplosion as EventListener);

    // Cleanup on page navigation
    document.addEventListener('astro:before-swap', () => {
      if (renderer) {
        renderer.destroy();
        renderer = null;
      }
      window.removeEventListener('ascii-settings-change', handleSettingsChange as EventListener);
      window.removeEventListener('ascii-effect-change', handleEffectChange as EventListener);
      window.removeEventListener('ascii-trigger-explosion', handleExplosion as EventListener);
    }, { once: true });
  }

  // Handle intensity transition on page navigation (Astro View Transitions)
  function handlePageTransition() {
    if (!renderer || reducedMotion) return;

    const newIntensity = getPageIntensity(reducedMotion);
    renderer.setIntensityAnimated(newIntensity, TWEEN_DURATION);
  }

  // Initialize
  initASCII();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:after-swap', () => {
    // If renderer still exists (persisted), just tween intensity
    if (renderer && !reducedMotion) {
      handlePageTransition();
    } else {
      initASCII();
    }
  });

  // Listen for reduced motion preference changes
  window.matchMedia('(prefers-reduced-motion: reduce)').addEventListener('change', (e) => {
    reducedMotion = e.matches;
    if (renderer) {
      const container = document.getElementById('ascii-background');
      if (reducedMotion) {
        renderer.setSpeed(0.3);
        renderer.setIntensityAnimated(REDUCED_MOTION_INTENSITY, TWEEN_DURATION);
        if (container) container.style.opacity = '0.3';
      } else {
        renderer.setSpeed(1);
        renderer.setIntensityAnimated(getPageIntensity(false), TWEEN_DURATION);
        if (container) container.style.opacity = '';
      }
    }
  });
</script>

<style>
  .ascii-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
    opacity: 0.6;
    transition: opacity 0.3s ease;
  }

  @media (prefers-reduced-motion: reduce) {
    .ascii-background {
      opacity: 0.2;
      transition: none;
    }
  }
</style>
