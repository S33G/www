---
import '@/styles/global.css';
import { ViewTransitions } from 'astro:transitions';
import { preferencesScript } from '@/lib/preferences';
import SkipLink from '@/components/ui/SkipLink.astro';
import SEOHead from '@/components/ui/SEOHead.astro';
import SettingsPanel from '@/components/ui/SettingsPanel';
import AnimatedFavicon from '@/components/ui/AnimatedFavicon.astro';

interface Props {
  title: string;
  description?: string;
  image?: string;
  article?: {
    publishedTime: string;
    tags?: string[];
  };
}

const { title, description = 'A developer blog with ASCII aesthetics', image, article } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const basePath = import.meta.env.BASE_URL.replace(/\/+$/, '') || '';
---

<!doctype html>
<html lang="en-GB" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <AnimatedFavicon />

    <!-- Prevent theme flash -->
    <script is:inline set:html={preferencesScript} />

    <ViewTransitions />

    <SEOHead
      title={title}
      description={description}
      canonicalURL={canonicalURL.toString()}
      image={image}
      article={article}
    />

    <!-- Preload mono font -->
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap"
      as="style"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap"
    />
  </head>
  <body data-base-path={basePath}>
    <SkipLink />
    <slot />
    <SettingsPanel client:load />

    <script>
      import { navigate } from 'astro:transitions/client';

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          const base = document.body.dataset.basePath || '';
          const homeUrl = base ? `${base}/` : '/';
          const currentPath = window.location.pathname;
          if (currentPath !== homeUrl && currentPath !== base && currentPath !== '/' && currentPath !== '') {
            navigate(homeUrl);
          }
        }
      });
    </script>
  </body>
</html>
