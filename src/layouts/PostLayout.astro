---
import BaseLayout from './BaseLayout.astro';
import Navigation from '@/components/ui/Navigation.astro';
import PostTitle from '@/components/content/PostTitle.astro';
import PostCard from '@/components/content/PostCard.astro';
import ASCIIBackground from '@/components/ascii/ASCIIBackground.astro';
import { formatDate } from '@/lib/utils';
import type { CollectionEntry } from 'astro:content';

interface Props {
  frontmatter: {
    title: string;
    description: string;
    pubDate: Date;
    updatedDate?: Date;
    tags?: string[];
    image?: string;
  };
  similarPosts?: CollectionEntry<'blog'>[];
  prevPost?: CollectionEntry<'blog'>;
  nextPost?: CollectionEntry<'blog'>;
  backHref?: string;
  backLabel?: string;
}

const {
  frontmatter,
  similarPosts = [],
  prevPost,
  nextPost,
  backHref = '/blog',
  backLabel = 'Back to posts',
} = Astro.props;
const prevHref = prevPost ? `/blog/${prevPost.slug}` : '';
const nextHref = nextPost ? `/blog/${nextPost.slug}` : '';
---

<BaseLayout
  title={frontmatter.title}
  description={frontmatter.description}
  image={frontmatter.image}
  article={{
    publishedTime: frontmatter.pubDate.toISOString(),
    tags: frontmatter.tags,
  }}
>
  <ASCIIBackground />

  <div class="post-layout">
    <Navigation />

    <main id="main-content">
      <article
        class="post"
        transition:animate="fade"
        data-post-navigation
        data-prev={prevHref}
        data-next={nextHref}
      >
        <header class="post-header">
          <a href="/blog" class="back-link">← Back to posts</a>
          <PostTitle title={frontmatter.title} />
          <div class="post-meta">
            <time datetime={frontmatter.pubDate.toISOString()}>
              {formatDate(frontmatter.pubDate)}
            </time>
            {frontmatter.updatedDate && (
              <span class="updated">
                · Updated {formatDate(frontmatter.updatedDate)}
              </span>
            )}
          </div>
          {frontmatter.tags && frontmatter.tags.length > 0 && (
            <div class="post-tags">
              {frontmatter.tags.map((tag) => (
                <a href={`/blog/tags/${tag}`} class="tag">{tag}</a>
              ))}
            </div>
          )}
        </header>

        <div class="post-content">
          <slot />
        </div>

        <footer class="post-footer">
          {similarPosts.length > 0 && (
            <section class="similar-posts">
              <h2>Related posts</h2>
              <div class="similar-posts-grid">
                {similarPosts.map((post) => (
                  <PostCard
                    slug={post.slug}
                    title={post.data.title}
                    description={post.data.description}
                    pubDate={post.data.pubDate}
                    tags={post.data.tags}
                  />
                ))}
              </div>
            </section>
          )}
          <a href="/blog" class="back-link">← Back to all posts</a>
        </footer>
      </article>
    </main>
  </div>
</BaseLayout>

<style>
  .post-layout {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  main {
    flex: 1;
    display: flex;
    justify-content: center;
    padding: var(--space-lg) var(--space-md);
  }

  .post {
    max-width: var(--container-max);
    width: 100%;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--space-xl);
    box-shadow: var(--shadow-md);
    position: relative;
  }

  .content-back-button {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
    width: 2.25rem;
    height: 2.25rem;
    display: grid;
    place-items: center;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-primary);
    background: color-mix(in srgb, var(--bg-primary) 80%, transparent);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    text-decoration: none;
    box-shadow: var(--shadow-sm);
    transition: background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast);
  }

  .content-back-button:hover,
  .content-back-button:focus-visible {
    background: var(--ascii-tint);
    border-color: var(--border-hover);
    color: var(--color-primary);
  }

  :global([data-astro-transition="fade"]) {
    animation: page-zoom-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
  }

  @keyframes page-zoom-in {
    0% {
      transform: scale(0.88);
      opacity: 0;
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .post-header {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
  }

  .post-header h1 {
    font-size: var(--font-size-xl);
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
  }

  .post-header h1 :global(code) {
    background-color: var(--bg-elevated);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 0.2em 0.4em;
    font-family: var(--font-mono);
    font-size: 0.95em;
    color: var(--color-primary);
  }

  .post-meta {
    color: var(--text-muted);
    font-size: var(--font-size-sm);
  }

  .updated {
    margin-left: var(--space-xs);
  }

  .post-tags {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    flex-wrap: wrap;
  }

  .tag {
    color: var(--color-primary);
    background: var(--ascii-tint);
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: var(--font-size-sm);
    text-decoration: none;
  }

  .tag:hover {
    background: var(--color-primary);
    color: white;
  }

  .post-content {
    line-height: 1.8;
  }

  .post-content :global(h2) {
    margin-top: var(--space-xl);
    color: var(--text-primary);
    font-size: var(--font-size-lg);
  }

  .post-content :global(h3) {
    margin-top: var(--space-lg);
    color: var(--text-primary);
  }

  .post-content :global(pre) {
    margin: var(--space-md) 0;
  }

  .post-content :global(.mermaid) {
    margin: var(--space-lg) calc(-1 * var(--space-xl));
    padding: var(--space-lg) var(--space-xl);
    overflow-x: auto;
    display: flex;
    justify-content: center;
  }

  .post-content :global(.mermaid svg) {
    height: auto;
  }

  .post-content :global(img) {
    margin-left: calc(-1 * var(--space-xl));
    margin-right: calc(-1 * var(--space-xl));
    width: calc(100% + 2 * var(--space-xl));
    height: auto;
    border-radius: var(--border-radius-sm);
  }

  .post-footer {
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--border-color);
  }

  .similar-posts {
    margin-bottom: var(--space-xl);
  }

  .similar-posts h2 {
    font-size: var(--font-size-lg);
    color: var(--text-primary);
    margin-bottom: var(--space-md);
  }

  .similar-posts-grid {
    display: grid;
    gap: var(--space-md);
  }

  .back-link {
    color: var(--text-muted);
    font-size: var(--font-size-sm);
    text-decoration: none;
    display: inline-block;
    margin-bottom: var(--space-md);
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  @media (max-width: 768px) {
    main {
      padding: var(--space-md) var(--space-sm);
    }

    .post {
      padding: var(--space-lg);
      border-radius: var(--border-radius-sm);
    }

    .content-back-button {
      top: var(--space-xs);
      right: var(--space-xs);
      width: 2rem;
      height: 2rem;
      font-size: 0.7rem;
    }
  }

  @media (max-width: 480px) {
    .post {
      border-left: none;
      border-right: none;
      border-radius: 0;
    }
  }
</style>

<script>
  function setupPostNavigation() {
    const post = document.querySelector('[data-post-navigation]');
    if (!post) return;

    const prev = post.getAttribute('data-prev') || '';
    const next = post.getAttribute('data-next') || '';
    if (!prev && !next) return;

    const onKeyDown = (event) => {
      if (event.defaultPrevented) return;
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const tagName = target.tagName;
      if (target.isContentEditable || ['INPUT', 'TEXTAREA', 'SELECT'].includes(tagName)) {
        return;
      }

      if (event.key === 'ArrowLeft' && prev) {
        window.location.href = prev;
      }

      if (event.key === 'ArrowRight' && next) {
        window.location.href = next;
      }
    };

    document.addEventListener('keydown', onKeyDown);

    const teardown = () => {
      document.removeEventListener('keydown', onKeyDown);
    };

    document.addEventListener('astro:before-swap', teardown, { once: true });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupPostNavigation, { once: true });
  } else {
    setupPostNavigation();
  }

  document.addEventListener('astro:after-swap', setupPostNavigation);
</script>

<script>
  function styleMermaidNodes(container: Element) {
    const rects = container.querySelectorAll<SVGRectElement>(
      '.node rect, .cluster rect, .label-container'
    );
    for (const rect of rects) {
      rect.setAttribute('rx', '10');
      rect.setAttribute('ry', '10');
    }

    const svg = container.querySelector('svg');
    if (!svg) return;

    let defs = svg.querySelector('defs');
    if (!defs) {
      defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      svg.prepend(defs);
    }

    if (!defs.querySelector('#mermaid-node-shadow')) {
      const filter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
      filter.setAttribute('id', 'mermaid-node-shadow');
      filter.setAttribute('x', '-10%');
      filter.setAttribute('y', '-10%');
      filter.setAttribute('width', '130%');
      filter.setAttribute('height', '140%');
      filter.innerHTML = `
        <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0,0,0,0.25)" flood-opacity="0.4"/>
      `;
      defs.appendChild(filter);
    }

    const nodes = container.querySelectorAll<SVGGElement>('.node, .cluster');
    for (const node of nodes) {
      node.style.filter = 'url(#mermaid-node-shadow)';
    }
  }

  function observeMermaidContainers() {
    const containers = document.querySelectorAll('.mermaid');
    if (containers.length === 0) return;

    const observer = new MutationObserver((mutations) => {
      for (const mutation of mutations) {
        const target = mutation.target as Element;
        const container = target.closest('.mermaid') ?? target;
        if (container.querySelector('svg')) {
          styleMermaidNodes(container);
        }
      }
    });

    for (const container of containers) {
      if (container.querySelector('svg')) {
        styleMermaidNodes(container);
      }
      observer.observe(container, { childList: true, subtree: true });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', observeMermaidContainers, { once: true });
  } else {
    observeMermaidContainers();
  }

  document.addEventListener('astro:after-swap', observeMermaidContainers);
</script>
