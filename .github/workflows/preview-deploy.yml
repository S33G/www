name: Preview Deploy

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
    - name: Sanitize branch name
      id: branch
      run: echo "name=$(echo '${{ github.head_ref }}' | sed 's/[^a-zA-Z0-9-]/-/g')" >> "$GITHUB_OUTPUT"

    - uses: actions/checkout@v4

    - uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Build preview
      run: bun run build
      env:
        PREVIEW_BASE: /preview-${{ steps.branch.outputs.name }}

    - name: Deploy preview to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        destination_dir: preview-${{ steps.branch.outputs.name }}
        keep_files: true

    - name: Find existing comment
      uses: peter-evans/find-comment@v3
      id: find-comment
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: github-actions[bot]
        body-includes: "<!-- preview-deploy -->"

    - name: Create or update comment
      uses: peter-evans/create-or-update-comment@v4
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        edit-mode: replace
        body: |
          <!-- preview-deploy -->
          ðŸ”— **Preview deploy ready!**

          https://s33g.uk/preview-${{ steps.branch.outputs.name }}/

          _Updated: ${{ github.event.pull_request.head.sha }}_
